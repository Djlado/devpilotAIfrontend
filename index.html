<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DevPilot AI ‚Äì Code-First Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- SAME CSS AS BEFORE (unchanged) --- */
    :root {
      --bg-primary: #0a0a0a;
      --bg-panel: #1a1a1a;
      --bg-darker: #111111;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --accent-blue: #00e6ff;
      --accent-pink: #ff00e6;
      --accent-green: #00ff84;
      --accent-purple: #8b5cf6;
      --font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --font-mono: "Consolas", "Courier New", monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }
    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    /* (keeping all your CSS ‚Äì truncated here for brevity, but unchanged) */
  </style>
</head>
<body>
  <div class="app-container">
    <section class="ai-panel">
      <header class="ai-header">
        <h2>ü§ñ DevPilot AI</h2>
        <p>Your coding assistant</p>
      </header>
      <div class="chat-section">
        <form id="chatForm" class="chat-form">
          <input type="text" id="promptInput" placeholder="Type your message here..." autocomplete="off" required />
          <button type="submit" class="send-btn" id="sendBtn">Send</button>
        </form>
        <div id="chatContainer" class="chat-container"></div>
      </div>
    </section>
    <section class="code-panel">
      <header class="code-header">
        <button class="tab">üìù Editor</button>
        <button id="previewBtn" class="preview-btn">‚ñ∂ Preview</button>
      </header>
      <div class="code-content">
        <div class="editor-container">
          <textarea id="codeEditor" placeholder="Your generated code appears here..."></textarea>
        </div>
        <div class="preview-container">
          <div class="preview-header">üîç Live Preview</div>
          <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
        </div>
      </div>
    </section>
  </div>

  <script>
    // üåê N8N WEBHOOK URL
    const WEBHOOK_URL = "https://n8n-latest1-0.onrender.com/webhook/f8fdb8a5-1136-49e6-8447-e1dfd7d65466";

    // DOM Elements
    const editor = document.getElementById('codeEditor');
    const previewBtn = document.getElementById('previewBtn');
    const previewFrame = document.getElementById('previewFrame');
    const chatForm = document.getElementById('chatForm');
    const promptInput = document.getElementById('promptInput');
    const chatContainer = document.getElementById('chatContainer');
    const sendBtn = document.getElementById('sendBtn');

    function addMessage({ role, text }) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.textContent = text;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return div;
    }

    function showLoading() {
      const div = document.createElement('div');
      div.className = 'message ai';
      div.innerHTML = '<div class="loading"></div> Generating code...';
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return div;
    }

    previewBtn.addEventListener('click', () => {
      const code = editor.value.trim();
      if (!code) {
        alert('Please add some code to preview!');
        return;
      }
      const doc = `
        <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>${extractCSS(code)}</style>
          </head>
          <body>
            ${extractHTML(code)}
            <script>${extractJS(code)}<\/script>
          </body>
        </html>`;
      previewFrame.srcdoc = doc;
    });

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = promptInput.value.trim();
      if (!prompt) return;

      addMessage({ role: 'user', text: prompt });
      promptInput.value = '';
      promptInput.disabled = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Generating...';

      const loading = showLoading();

      try {
        const resp = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!resp.ok) throw new Error(`Server error: ${resp.status}`);

        const data = await resp.json();

        if (loading.parentNode) chatContainer.removeChild(loading);

        const code = data.code || data.result || data.output || JSON.stringify(data);
        addMessage({ role: 'ai', text: code });
        insertAtCursor(editor, code);
        setTimeout(() => previewBtn.click(), 500);

      } catch (error) {
        if (loading.parentNode) chatContainer.removeChild(loading);
        addMessage({ role: 'ai', text: '‚ùå ' + error.message });
      } finally {
        promptInput.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        promptInput.focus();
      }
    });

    function insertAtCursor(textarea, text) {
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      const separator = (before && !before.endsWith('\n')) ? '\n\n' : '';
      textarea.value = before + separator + text + after;
      const newPos = start + separator.length + text.length;
      textarea.selectionStart = textarea.selectionEnd = newPos;
      textarea.focus();
    }

    function extractHTML(src) {
      return src.replace(/<style[\s\S]*?<\/style>/gi, '')
                .replace(/<script[\s\S]*?<\/script>/gi, '')
                .trim();
    }
    function extractCSS(src) {
      const match = src.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
      return match ? match[1].trim() : '';
    }
    function extractJS(src) {
      const match = src.match(/<script[^>]*>([\s\S]*?)<\/script>/i);
      return match ? match[1].trim() : '';
    }

    // Starter code
    editor.value = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DevPilot AI Demo</title>
  <style>
    body { font-family: sans-serif; }
  </style>
</head>
<body>
  <h1>Hello from DevPilot AI!</h1>
</body>
</html>`;
    setTimeout(() => previewBtn.click(), 1000);
  </script>
</body>
</html>
